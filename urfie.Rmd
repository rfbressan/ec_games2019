---
title: "Using R for Introductory Econometrics"
author: "Rafael F. Bressan"
date: "`r Sys.Date()`"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Site do livro: http://www.urfie.net/downloads.html

```{r libraries, include=FALSE}
library(wooldridge) # Load data sets
library(plm)
library(estimatr)
library(lmtest)
library(car)
library(MASS)
library(AER) # ivreg
library(tidyverse)
library(pmdplyr)
library(broom)
library(forcats)
library(purrr)
library(stargazer)
library(kableExtra)
```

# Carregando os dados 

```{r data}
data("gpa3")
data("k401ksubs")
data("hprice1")
data("smoke")
data("kielmc")
```

# Análise descritiva

Primeiro separar variáveis qualitativas das quantitativas

```{r desc}
quali <- gpa3 %>% 
  select(term, season, frstsem, spring, female, black, football) %>% 
  mutate_all(as.factor)

quanti <- gpa3 %>% 
  select(-c(term, season, frstsem, spring, female, black, football, white))

```

Descrição das qualitativas


```{r quali, results = "asis"}
desc_quali <- quali %>% 
  pivot_longer(everything()) %>% 
  count(name, value) %>% 
  pivot_wider(names_from = value, values_from = n)

stargazer(desc_quali, summary = FALSE, rownames = FALSE, type = "html")
```

Descrição das quantitativas

```{r quanti, results = "asis"}
desc_quanti <- quanti %>% 
  pivot_longer(everything()) %>% 
  group_by(name) %>% 
  summarise(media = mean(value, na.rm = TRUE), 
            mediana = median(value, na.rm = TRUE),
            desv_pad = sd(value, na.rm = TRUE),
            na = sum(is.na(value)))

stargazer(desc_quanti, summary = FALSE, rownames = FALSE, type = "html",
          digits = 2, digits.extra = 4)
```


## Boxplot para detecção de outliers

```{r boxplot}
quanti %>% 
  select(-id) %>% 
  mutate_all(scale) %>% 
  pivot_longer(everything()) %>% 
  ggplot(aes(x = name, y = value, color = name)) +
  geom_boxplot() +
  labs(title = "Boxplot",
       y = "Valor",
       x = "Variável") +
  guides(color = FALSE) +
  theme_classic()
```


# Multiple OLS Regression. Example 8.2

```{r mols, results="asis"}
reg <- gpa3 %>% 
  filter(spring == 1) %>% 
  lm(cumgpa ~ sat + hsperc + tothrs + female + black + white, 
     data = .)

stargazer(coeftest(reg), coeftest(reg, vcov. = hccm), type = "html",
          column.labels = c("Padrão", "Robusto"),
          align = TRUE,
          no.space = TRUE,
          title = "Regressão com erros padrão e robustos.")
```

## Teste F para black=white=0

```{r teste-f, results = "asis"}
myH0 <- c("black", "white")

stargazer(linearHypothesis(reg, myH0, vcov. = hccm), type = "html")
```

## Regressão robusta com `rlm` do pacote MASS

```{r rlm, results = "asis"}
rob_reg <- gpa3 %>% 
  filter(spring == 1) %>% 
  rlm(cumgpa ~ sat + hsperc + tothrs + female + black + white, 
      data = .)

stargazer(rob_reg, type = "html")
```

# Mínimos quadrados ponderados

```{r wls, results = "asis"}
wlsreg <- k401ksubs %>% 
  filter(fsize == 1) %>% 
  lm(nettfa ~ inc+I((age-25)^2)+male+e401k, 
     weights = 1/inc,
     data = .)

stargazer(coeftest(wlsreg), coeftest(wlsreg, vcov. = hccm),
          type = "html",
          no.space = TRUE,
          align = TRUE,
          column.labels = c("Padrão", "Robusto"))
```

## Teste de Breusch-Pagan para heterocedasticidade

```{r bp, resutls = "asis"}
bp <- bptest(wlsreg)
bp
```

## Teste RESET de Ramsey

```{r reset, results = "asis"}
orig <- hprice1 %>% 
  lm(price ~ lotsize+sqrft+bdrms, data = .)
resettest(orig)
```

# Feasible GLS (variância desconhecida)

```{r fgls, results = 'asis'}
ols <- smoke %>% 
  lm(cigs ~ log(income) + log(cigpric) + educ + age + I(age^2) + restaurn,
     data = .)
# BP test on OLS
bptest(ols)

# FGLS
logu2 <- log(resid(ols)^2)
yhat <- fitted(ols)
yhat2 <- yhat^2

# FGLS: regress log(u^2) on X
varreg1 <- smoke %>% 
  lm(logu2 ~ log(income) + log(cigpric) + educ + age + I(age^2) + restaurn,
     data = .)
# Weights will be 1/exp(logu2_fit)
w1 <- 1 / exp(fitted(varreg1))
# FGLS: OLS regression again, with weights
fgls1 <- smoke %>% 
  lm(cigs ~ log(income) + log(cigpric) + educ + age + I(age^2) + restaurn,
     data = ., weights = w1)

# FGLS: regress log(u^2) on yhat and yhat2
varrreg2 <- lm(logu2 ~ yhat + yhat2)
w2 <- 1 / exp(fitted(varrreg2))
# FGLS: OLS regression again, with weights
fgls2 <- smoke %>% 
  lm(cigs ~ log(income) + log(cigpric) + educ + age + I(age^2) + restaurn,
     data = ., weights = w2)

stargazer(coeftest(ols), coeftest(fgls1), coeftest(fgls2),
          type = "html",
          no.space = TRUE,
          align = TRUE,
          column.labels = c("OLS", "FGLS1", "FGLS2"))
```

# Dados em Painel

## Dois períodos: Dif-in-Dif

Exemplo 13.3 de Wooldridge. Análise de decisão de políticas com agrupamentos de cortes tranversais. Será um modelo dif-in-dif com variável temporal e grupo de tratamento e controle antes e depois.

Primeiro regressões separadas para cada ano de interesse: 1978 e 1981

```{r dif-kiel, results = 'asis'}
reg <- kielmc %>% 
  group_by(year) %>% 
  nest() %>% 
  mutate(regression = map(data, ~lm(rprice ~ nearinc, data = .x)))

stargazer(coeftest(reg$regression[[1]], vcov. = hccm), 
          coeftest(reg$regression[[2]], vcov. = hccm),
          type = "html",
          no.space = TRUE,
          align = TRUE,
          column.labels = c("1978", "1981"))
```

Ambos intercepto e inclinação são diferentes entre os anos de 1978 e 1981. Pode-se estimar então um modelo com variável dummy para indicar o ano de 1981 e a interação desta dummy com a variável de tratamento `nearinc`.

```{r dif-dif, results = 'asis'}
dif_reg <- kielmc %>% 
  lm(rprice ~ nearinc*y81, data = .)

stargazer(coeftest(dif_reg, vcov. = hccm), 
          type = "html",
          no.space = TRUE,
          align = TRUE,
          column.labels = c("Dif-in-Dif"))
```

## Painéis longos

Pooled

```{r pooled, resutls = 'asis'}
data("nls_panel", package = "PoEdata")
nlspd <- pdata.frame(nls_panel, index = c("id", "year"))
pdim(nlspd)

wage.pooled <- nlspd %>% 
  plm(lwage~educ+exper+I(exper^2)+tenure+I(tenure^2)+black+south+union, 
  model = "pooling", 
  data = .)

tbl <- tidy(coeftest(wage.pooled, 
                     vcov = vcovHC(wage.pooled, type = "HC0", cluster = "group")))
kable(tbl, 
      digits = 2, 
      caption = "Pooled 'wage' model with cluster robust standard errors")
```

Efeitos Fixos considera que os interceptos de cada indivíduo podem ser diferentes. Uma desvantagem é que se perde qualquer variável explanatória que seja constante no tempo. Veja como educ e black não aparecem nos resultados.

```{r within, resutls = 'asis'}
data("nls_panel", package = "PoEdata")
nlspd <- pdata.frame(nls_panel, index = c("id", "year"))
pdim(nlspd)

wage.within <- nlspd %>% 
  plm(lwage~educ+exper+I(exper^2)+tenure+I(tenure^2)+black+south+union, 
  model = "within", 
  data = .)

tbl <- tidy(coeftest(wage.within, 
                     vcov = vcovHC(wage.within, type = "HC0", cluster = "group")))
kable(tbl, 
      digits = 2, 
      caption = "Within 'wage' model with cluster robust standard errors")
```

Testing if fixed effets are necessary is to compare the fixed effects model wage.within with the pooled model wage.pooled. The function `pFtest()` do pacote `plm` does this comparison.

```{r fe_pool_test, results = 'asis'}
kable(tidy(pFtest(wage.within, wage.pooled)), 
      caption = "Fixed effects test: Ho:'No fixed effects'")
```

Neste caso deve-se rejeitar a H0 que não há diferença nos interceptos dos indivíduos (efeitos fixos não observáveis).

Efeitos Aleatórios



Primeira Diferença